# Deployment Fix for Subdomain and HTTPS Issues

## Problem
- Other subdomains (e.g., emergency-comm.alertaraqc.com) were showing the wrong domain (disaster-preparedness.alertaraqc.com)
- HTTPS was being replaced with HTTP only

## Solution Implemented

### 1. TrustProxies Middleware
Created `app/Http/Middleware/TrustProxies.php` to properly detect HTTPS and domain from proxy headers (X-Forwarded-Proto, X-Forwarded-Host, etc.).

### 2. AppServiceProvider Updates
Updated `app/Providers/AppServiceProvider.php` to:
- Dynamically detect HTTPS from the request
- Force HTTPS scheme when detected
- **NOT** force a specific domain, allowing each subdomain to work independently

### 3. .htaccess Updates
Updated `public/.htaccess` to properly handle HTTPS detection from the `X-Forwarded-Proto` header.

### 4. Bootstrap Configuration
Updated `bootstrap/app.php` to register the TrustProxies middleware.

## Required Environment Variables

Make sure your `.env` file has the following settings:

```env
# DO NOT hardcode a specific subdomain - leave this as the base domain or use a wildcard
APP_URL=https://alertaraqc.com

# Session configuration - DO NOT set SESSION_DOMAIN to a specific subdomain
# Leave SESSION_DOMAIN empty or set to the base domain (.alertaraqc.com) if you want to share sessions
# For separate sessions per subdomain, leave it empty
SESSION_DOMAIN=

# Enable secure cookies when using HTTPS
SESSION_SECURE_COOKIE=true

# Force HTTPS detection
FORCE_HTTPS=true
```

## Web Server Configuration

### For Nginx
Make sure your Nginx configuration passes the correct headers:

```nginx
location / {
    proxy_pass http://your-backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
}
```

### For Apache
If using Apache with mod_proxy, ensure these headers are passed:

```apache
ProxyPreserveHost On
ProxyPassReverse / http://your-backend/
RequestHeader set X-Forwarded-Proto "https" env=HTTPS
RequestHeader set X-Forwarded-Host %{HTTP_HOST}e
```

## Important Notes

1. **APP_URL**: Should NOT be set to a specific subdomain. Use the base domain or leave it flexible.

2. **Session Domain**: 
   - If you want separate sessions per subdomain: Leave `SESSION_DOMAIN` empty
   - If you want shared sessions across subdomains: Set `SESSION_DOMAIN=.alertaraqc.com` (with leading dot)

3. **HTTPS Detection**: The application now automatically detects HTTPS from:
   - Direct HTTPS connections
   - `X-Forwarded-Proto: https` header (from load balancers/proxies)
   - `X-Forwarded-Port: 443` header

4. **Domain Detection**: The application now uses the actual request domain instead of a hardcoded `APP_URL`, allowing each subdomain to work independently.

## Testing

After deployment, test:
1. Access `https://emergency-comm.alertaraqc.com` - should show correct domain and HTTPS
2. Access `https://disaster-preparedness.alertaraqc.com` - should work correctly
3. Check that URLs generated by Laravel use the correct domain and HTTPS scheme
4. Verify cookies are set with the correct domain and secure flag

## Rollback

If issues occur, you can temporarily revert by:
1. Removing the TrustProxies middleware registration from `bootstrap/app.php`
2. Reverting `AppServiceProvider.php` to its original state
3. However, the root cause (web server configuration) should be fixed instead
